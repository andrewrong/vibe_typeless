# macOS æ€§èƒ½ä¼˜åŒ–æŒ‡å—

## âš ï¸ é‡è¦ï¼šDocker vs æœ¬åœ°éƒ¨ç½²æ€§èƒ½å¯¹æ¯”

### MLX åœ¨ macOS Docker ä¸­çš„æ€§èƒ½é—®é¢˜

#### macOS Docker æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  macOS (Apple Silicon)                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Docker Desktop (HyperKit Linux VM)                â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚ Docker Container (Python + MLX)              â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  âŒ æ— æ³•è®¿é—® macOS GPU/NE                    â”‚   â”‚  â”‚
â”‚  â”‚  â”‚  âœ… åªèƒ½ä½¿ç”¨ CPU                             â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®é™åˆ¶ï¼š**
1. **æ— æ³•ä½¿ç”¨ GPU/ç¥ç»å¼•æ“** - Docker Linux VM æ— æ³•è®¿é—® macOS çš„ç¡¬ä»¶åŠ é€Ÿ
2. **è™šæ‹ŸåŒ–å¼€é”€** - é¢å¤–çš„è™šæ‹ŸåŒ–å±‚ä¼šå¢åŠ  10-20% æ€§èƒ½æŸå¤±
3. **èµ„æºé™åˆ¶** - CPU/å†…å­˜é™åˆ¶ä¼šè¿›ä¸€æ­¥å½±å“æ€§èƒ½

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### Whisper large-v3 è½¬å½•é€Ÿåº¦ï¼ˆ35 ç§’éŸ³é¢‘ï¼‰

| éƒ¨ç½²æ–¹å¼ | è½¬å½•æ—¶é—´ | ç›¸å¯¹æ€§èƒ½ | å†…å­˜å ç”¨ |
|---------|---------|----------|----------|
| **æœ¬åœ°éƒ¨ç½²** | ~5-8 ç§’ | 100% âœ… | 4-6 GB |
| **Docker (æ— é™åˆ¶)** | ~8-12 ç§’ | 60-70% âš ï¸ | 6-8 GB |
| **Docker (ä¸¥æ ¼é™åˆ¶)** | ~15-20 ç§’ | 30-40% âŒ | å—é™ |

### æ€§èƒ½å½±å“å› ç´ 

```python
# æœ¬åœ°éƒ¨ç½² - MLX ä½¿ç”¨ GPU
MLX æ€§èƒ½: 100%
â”œâ”€ GPU åŠ é€Ÿ: âœ… å¯ç”¨
â”œâ”€ ç¥ç»å¼•æ“: âœ… å¯ç”¨
â””â”€ ç»Ÿä¸€å†…å­˜: âœ… å¯ç”¨

# Docker éƒ¨ç½² - MLX åªèƒ½ç”¨ CPU
MLX æ€§èƒ½: 60-70%
â”œâ”€ GPU åŠ é€Ÿ: âŒ ä¸å¯ç”¨
â”œâ”€ ç¥ç»å¼•æ“: âŒ ä¸å¯ç”¨
â”œâ”€ CPU é™åˆ¶: âš ï¸ å— docker-compose.yml å½±å“
â””â”€ å†…å­˜é™åˆ¶: âš ï¸ å— docker-compose.yml å½±å“
```

## ğŸš€ æ¨èé…ç½®æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: æ— èµ„æºé™åˆ¶ï¼ˆæ¨èï¼‰

é€‚åˆ **å¼€å‘/æµ‹è¯•** å’Œ **æ€§èƒ½ä¼˜å…ˆ** åœºæ™¯ï¼š

```yaml
# docker-compose.yml
deploy:
  resources:
    limits:
      cpus: '8'      # 8 æ ¸ = å®é™…ä¸Šä¸é™åˆ¶ï¼ˆå¤§å¤šæ•° Mac åªæœ‰ 8-12 æ€§èƒ½æ ¸ï¼‰
      memory: 16G   # è®¾ç½®è¶³å¤Ÿé«˜çš„å€¼
    reservations:
      cpus: '4'
      memory: 8G
```

**ä¼˜ç‚¹ï¼š**
- âœ… æ¥è¿‘æœ¬åœ°éƒ¨ç½²æ€§èƒ½
- âœ… å……åˆ†åˆ©ç”¨ CPU
- âœ… é€‚åˆå¼€å‘æµ‹è¯•

**ç¼ºç‚¹ï¼š**
- âš ï¸ ä»ç„¶æ— æ³•ä½¿ç”¨ GPU
- âš ï¸ æ¯”æœ¬åœ°æ…¢ 30-40%

### æ–¹æ¡ˆ 2: ç§»é™¤èµ„æºé™åˆ¶ï¼ˆæœ€æ¨èï¼‰

**ç¼–è¾‘ docker-compose.ymlï¼š**

```yaml
services:
  typeless-backend:
    # ... å…¶ä»–é…ç½® ...
    restart: unless-stopped

    # âš ï¸ å®Œå…¨ç§»é™¤èµ„æºé™åˆ¶ä»¥è·å¾—æœ€ä½³æ€§èƒ½
    # æ³¨é‡Šæ‰æˆ–åˆ é™¤ deploy.resources éƒ¨åˆ†

    # å¥åº·æ£€æŸ¥
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    networks:
      - typeless-network
```

**ä¼˜ç‚¹ï¼š**
- âœ… æœ€ä½³å®¹å™¨æ€§èƒ½
- âœ… è‡ªåŠ¨é€‚åº”å®¿ä¸»æœºèµ„æº
- âœ… é…ç½®æœ€ç®€å•

**ç¼ºç‚¹ï¼š**
- âŒ ä»æ— æ³•ä½¿ç”¨ GPUï¼ˆDocker é™åˆ¶ï¼‰
- âš ï¸ éœ€è¦æ‰‹åŠ¨ç›‘æ§èµ„æºä½¿ç”¨

### æ–¹æ¡ˆ 3: æœ¬åœ°éƒ¨ç½²ï¼ˆæ€§èƒ½æœ€ä½³ï¼‰

å¯¹äº **ç”Ÿäº§ç¯å¢ƒ** å’Œ **æ€§èƒ½è¦æ±‚é«˜** çš„åœºæ™¯ï¼š

```bash
# ä½¿ç”¨æœ¬åœ°éƒ¨ç½²è€Œé Docker
cd PythonService
./start.sh  # æœ¬åœ°éƒ¨ç½²
```

**ä¼˜ç‚¹ï¼š**
- âœ… å®Œæ•´ GPU/ç¥ç»å¼•æ“åŠ é€Ÿ
- âœ… æœ€ä½³æ€§èƒ½ï¼ˆ100%ï¼‰
- âœ… å†…å­˜å ç”¨æœ€ä½
- âœ… è°ƒè¯•æœ€æ–¹ä¾¿

**ç¼ºç‚¹ï¼š**
- âš ï¸ ç¯å¢ƒéš”ç¦»è¾ƒå¼±
- âš ï¸ éœ€è¦æœ¬åœ° Python ç¯å¢ƒ

## ğŸ¯ æ ¹æ®åœºæ™¯é€‰æ‹©

### å¼€å‘/è°ƒè¯•

**æ¨èï¼šæœ¬åœ°éƒ¨ç½²**

```bash
./start.sh  # å®Œæ•´æ€§èƒ½ï¼Œæ–¹ä¾¿è°ƒè¯•
```

**ç†ç”±ï¼š**
- å¿«é€Ÿè¿­ä»£
- å®æ—¶æŸ¥çœ‹æ—¥å¿—
- å®Œæ•´ GPU æ€§èƒ½
- æ˜“äºä¿®æ”¹ä»£ç 

### æµ‹è¯•/æ¼”ç¤º

**æ¨èï¼šDocker éƒ¨ç½²ï¼ˆç§»é™¤èµ„æºé™åˆ¶ï¼‰**

```bash
./docker-start.sh
```

**ç†ç”±ï¼š**
- ç¯å¢ƒéš”ç¦»
- æ˜“äºåˆ†äº«
- æ€§èƒ½å¯æ¥å—
- ä¸€é”®å¯åŠ¨/åœæ­¢

### ç”Ÿäº§ç¯å¢ƒ

**æ¨èï¼šæœ¬åœ°éƒ¨ç½²ï¼ˆæ€§èƒ½ä¼˜å…ˆï¼‰**

```bash
# ä½¿ç”¨ launchd æˆ– supervisord å®ˆæŠ¤è¿›ç¨‹
./start.sh
```

**ç†ç”±ï¼š**
- æœ€ä½³æ€§èƒ½
- èµ„æºåˆ©ç”¨ç‡æœ€é«˜
- æˆæœ¬æœ€ä½

## ğŸ“ å…·ä½“ä¼˜åŒ–å»ºè®®

### 1. ç§»é™¤èµ„æºé™åˆ¶ï¼ˆæ¨èï¼‰

```bash
cd PythonService

# ç¼–è¾‘ docker-compose.yml
nano docker-compose.yml

# æ‰¾åˆ° deploy.resources éƒ¨åˆ†ï¼Œå®Œå…¨åˆ é™¤æˆ–æ³¨é‡Š
# éƒ¨ç½²æ—¶ï¼š
docker-compose up -d
```

### 2. è°ƒæ•´é™åˆ¶ä¸ºåˆç†å€¼

å¦‚æœå¿…é¡»ä¿ç•™èµ„æºé™åˆ¶ï¼Œæ ¹æ®ä½ çš„æœºå™¨é…ç½®ï¼š

**8GB å†…å­˜ Macï¼š**

```yaml
deploy:
  resources:
    limits:
      cpus: '6'
      memory: 6G
    reservations:
      cpus: '2'
      memory: 3G
```

**16GB å†…å­˜ Macï¼š**

```yaml
deploy:
  resources:
    limits:
      cpus: '10'     # ä¸é™åˆ¶
      memory: 12G
    reservations:
      cpus: '4'
      memory: 6G
```

**32GB å†…å­˜ Macï¼š**

```yaml
deploy:
  resources:
    limits:
      cpus: '12'     # ä¸é™åˆ¶
      memory: 24G
    reservations:
      cpus: '6'
      memory: 12G
```

### 3. ç›‘æ§èµ„æºä½¿ç”¨

```bash
# æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨
docker stats typeless-backend

# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
docker-compose logs -f typeless-backend | grep "æ€§èƒ½"

# è¿›å…¥å®¹å™¨æŸ¥çœ‹ MLX è®¾å¤‡
docker-compose exec typeless-backend python -c "
import mlx.core as mx
print('MLX å¯ç”¨è®¾å¤‡:', mx.devices)
"
```

## ğŸ§ª æ€§èƒ½æµ‹è¯•

### å¯¹æ¯”æµ‹è¯•è„šæœ¬

```bash
# æœ¬åœ°éƒ¨ç½²æ€§èƒ½
cd PythonService
./start.sh
time curl -X POST --data-binary @test_audio.wav \
  http://127.0.0.1:28111/api/asr/transcribe

# Docker éƒ¨ç½²æ€§èƒ½
./stop.sh
./docker-start.sh
time curl -X POST --data-binary @test_audio.wav \
  http://127.0.0.1:28111/api/asr/transcribe
```

### é¢„æœŸç»“æœ

- **æœ¬åœ°éƒ¨ç½²**ï¼š5-8 ç§’
- **Dockerï¼ˆæ— é™åˆ¶ï¼‰**ï¼š8-12 ç§’
- **Dockerï¼ˆä¸¥æ ¼é™åˆ¶ï¼‰**ï¼š15-20 ç§’

## âš¡ è¿›ä¸€æ­¥ä¼˜åŒ–

### æœ¬åœ°éƒ¨ç½²ä¼˜åŒ–

```bash
# 1. ç¡®ä¿ MLX ä½¿ç”¨ GPU
python -c "
import mlx.core as mx
print('GPU å¯ç”¨:', mx.metal.is_available())
"

# 2. è°ƒæ•´æ¨¡å‹å¤§å°
# ç¼–è¾‘ src/asr/model_config.py
MODEL_SIZE = "large-v3"  # æˆ– "base", "small"

# 3. å¢åŠ å·¥ä½œçº¿ç¨‹
export OMP_NUM_THREADS=8
./start.sh
```

### Docker ä¼˜åŒ–

```bash
# 1. ä½¿ç”¨ host ç½‘ç»œæ¨¡å¼ï¼ˆå‡å°‘ç½‘ç»œå¼€é”€ï¼‰
# ç¼–è¾‘ docker-compose.yml
network_mode: "host"

# 2. å¢åŠ å…±äº«å†…å­˜
docker-compose down
# ä¿®æ”¹ docker-compose.yml
services:
  typeless-backend:
    shm_size: '2gb'  # å…±äº«å†…å­˜
    ...

# 3. ä½¿ç”¨ --privileged æ¨¡å¼ï¼ˆä¸æ¨èï¼‰
docker-compose run --privileged ...
```

## ğŸ“‹ æ€»ç»“å»ºè®®

### æœ€ç»ˆæ¨èé…ç½®

**å¼€å‘ç¯å¢ƒï¼š**
```bash
ä½¿ç”¨æœ¬åœ°éƒ¨ç½²ï¼ˆ./start.shï¼‰
- 100% æ€§èƒ½
- æ–¹ä¾¿è°ƒè¯•
- å¿«é€Ÿè¿­ä»£
```

**æµ‹è¯•/æ¼”ç¤ºï¼š**
```bash
ä½¿ç”¨ Docker + ç§»é™¤èµ„æºé™åˆ¶
- ç¯å¢ƒéš”ç¦»
- æ€§èƒ½å¯æ¥å—ï¼ˆ60-70%ï¼‰
- æ˜“äºéƒ¨ç½²
```

**ç”Ÿäº§ç¯å¢ƒï¼š**
```bash
ä½¿ç”¨æœ¬åœ°éƒ¨ç½² + è¿›ç¨‹å®ˆæŠ¤
- æœ€ä½³æ€§èƒ½
- æˆæœ¬æœ€ä½
- ç¨³å®šå¯é 
```

## ğŸ” å¦‚ä½•åˆ¤æ–­æ˜¯å¦å—èµ„æºé™åˆ¶å½±å“

```bash
# 1. æŸ¥çœ‹å®¹å™¨æ—¥å¿—
docker-compose logs | grep -i "error\|warning"

# 2. æ£€æŸ¥æ˜¯å¦è¢«é™æµ
docker stats typeless-backend

# 3. æŸ¥çœ‹è¿›ç¨‹ CPU ä½¿ç”¨
docker-compose exec typeless-backend top

# 4. æµ‹è¯•è½¬å½•é€Ÿåº¦
time curl -X POST --data-binary @test_audio.wav \
  http://localhost:28111/api/asr/transcribe
```

**æ€§èƒ½æŒ‡æ ‡ï¼š**
- âœ… < 10 ç§’ï¼ˆ35 ç§’éŸ³é¢‘ï¼‰ï¼šæ­£å¸¸
- âš ï¸ 10-15 ç§’ï¼šè½»åº¦å—é™
- âŒ > 15 ç§’ï¼šä¸¥é‡å—é™

---

**å»ºè®®ï¼šä¼˜å…ˆä½¿ç”¨æœ¬åœ°éƒ¨ç½²ï¼ŒDocker ä»…ç”¨äºç¯å¢ƒéš”ç¦»éœ€æ±‚å¼ºçƒˆçš„åœºæ™¯ã€‚**
